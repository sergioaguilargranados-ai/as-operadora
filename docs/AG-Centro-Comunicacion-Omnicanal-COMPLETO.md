# ğŸ¯ CENTRO DE COMUNICACIÃ“N OMNICANAL - ARQUITECTURA COMPLETA

**Fecha:** 5 de Febrero de 2026  
**Estado:** âœ… **SISTEMA COMPLETO**

---

## ğŸ“Š **ARQUITECTURA DEL SISTEMA**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CENTRO DE COMUNICACIÃ“N                        â”‚
â”‚                         (Unified Inbox)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     EMAIL     â”‚    â”‚   WHATSAPP    â”‚    â”‚      SMS      â”‚
â”‚   (Nodemailer)â”‚    â”‚    (Twilio)   â”‚    â”‚   (Twilio)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BASE DE DATOS UNIFICADA                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ communication_   â”‚  â”‚   messages   â”‚  â”‚ message_         â”‚  â”‚
â”‚  â”‚    threads       â”‚  â”‚              â”‚  â”‚  deliveries      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ **FLUJOS DE COMUNICACIÃ“N**

### **1. Email (AutomÃ¡tico)**

```
Evento del Sistema
  â†“
emailHelper.ts
  â†“
Nodemailer (SMTP)
  â†“
Cliente recibe email
  â†“
Registrado en message_deliveries
```

**Eventos que disparan emails:**
- Registro de usuario â†’ VerificaciÃ³n de email
- Email verificado â†’ Bienvenida
- Reserva creada â†’ ConfirmaciÃ³n de reserva
- Pago recibido â†’ ConfirmaciÃ³n de pago
- CotizaciÃ³n enviada â†’ Email de cotizaciÃ³n
- 24-48h antes de expirar â†’ Recordatorio de cotizaciÃ³n
- 7, 3, 1 dÃ­a antes del viaje â†’ Recordatorio pre-viaje
- 2-3 dÃ­as despuÃ©s del viaje â†’ Encuesta post-viaje
- Cambio en reserva â†’ NotificaciÃ³n de cambio
- Olvido de contraseÃ±a â†’ RecuperaciÃ³n de contraseÃ±a

### **2. WhatsApp (Bidireccional)**

```
ENVÃO:
Sistema/Agente
  â†“
MessagingService.sendWhatsAppMessage()
  â†“
Twilio API
  â†“
Cliente recibe WhatsApp
  â†“
Twilio notifica estado (webhook)
  â†“
Sistema actualiza estado

RECEPCIÃ“N:
Cliente envÃ­a WhatsApp
  â†“
Twilio recibe mensaje
  â†“
Webhook: /api/webhooks/whatsapp
  â†“
MessagingService.processIncomingMessage()
  â†“
Busca/crea hilo de conversaciÃ³n
  â†“
Guarda mensaje en BD
  â†“
Notifica a agentes
  â†“
Agente responde desde Centro de ComunicaciÃ³n
```

### **3. SMS (Bidireccional)**

```
ENVÃO:
Sistema/Agente
  â†“
MessagingService.sendSMSMessage()
  â†“
Twilio API
  â†“
Cliente recibe SMS
  â†“
Twilio notifica estado (webhook)
  â†“
Sistema actualiza estado

RECEPCIÃ“N:
Cliente envÃ­a SMS
  â†“
Twilio recibe mensaje
  â†“
Webhook: /api/webhooks/sms
  â†“
MessagingService.processIncomingMessage()
  â†“
Busca/crea hilo de conversaciÃ³n
  â†“
Guarda mensaje en BD
  â†“
Notifica a agentes
  â†“
Agente responde desde Centro de ComunicaciÃ³n
```

---

## ğŸ“ **ESTRUCTURA DE ARCHIVOS**

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ EmailService.ts              âœ… Servicio de email
â”‚   â”œâ”€â”€ MessagingService.ts          âœ… Servicio WhatsApp/SMS
â”‚   â””â”€â”€ CommunicationService.ts      âœ… Centro de comunicaciÃ³n
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ emailHelper.ts               âœ… 14 funciones de email
â”‚   â””â”€â”€ itineraryNotifications.ts    âœ… Notificaciones de cambios
â”‚
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ email/
â”‚       â”œâ”€â”€ welcome.html             âœ… 14 templates HTML
â”‚       â”œâ”€â”€ booking-confirmed.html
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ cron/
â”‚   â””â”€â”€ email-reminders.ts           âœ… Cron jobs automÃ¡ticos
â”‚
â””â”€â”€ app/
    â””â”€â”€ api/
        â”œâ”€â”€ auth/
        â”‚   â”œâ”€â”€ forgot-password/     âœ… RecuperaciÃ³n
        â”‚   â”œâ”€â”€ reset-password/      âœ… Reset
        â”‚   â”œâ”€â”€ verify-email/        âœ… VerificaciÃ³n
        â”‚   â””â”€â”€ resend-verification/ âœ… ReenvÃ­o
        â”‚
        â”œâ”€â”€ messaging/
        â”‚   â”œâ”€â”€ send/                âœ… Enviar WhatsApp/SMS
        â”‚   â””â”€â”€ conversations/       âœ… Obtener conversaciones
        â”‚
        â”œâ”€â”€ webhooks/
        â”‚   â”œâ”€â”€ whatsapp/            âœ… Recibir WhatsApp
        â”‚   â”œâ”€â”€ sms/                 âœ… Recibir SMS
        â”‚   â””â”€â”€ message-status/      âœ… Estado de mensajes
        â”‚
        â”œâ”€â”€ bookings/
        â”‚   â””â”€â”€ notify-change/       âœ… Notificar cambios
        â”‚
        â””â”€â”€ cron/
            â””â”€â”€ email-reminders/     âœ… Ejecutar cron jobs
```

---

## ğŸ—„ï¸ **BASE DE DATOS**

### **Tablas Principales**

```sql
-- Hilos de conversaciÃ³n (unificados)
communication_threads
â”œâ”€â”€ id
â”œâ”€â”€ thread_type              -- 'email' | 'whatsapp' | 'sms'
â”œâ”€â”€ subject
â”œâ”€â”€ client_id                -- FK a users
â”œâ”€â”€ assigned_agent_id        -- FK a users
â”œâ”€â”€ status                   -- 'open' | 'closed' | 'archived'
â”œâ”€â”€ priority                 -- 'low' | 'normal' | 'high' | 'urgent'
â”œâ”€â”€ message_count
â”œâ”€â”€ unread_count_client
â”œâ”€â”€ unread_count_agent
â””â”€â”€ last_message_at

-- Mensajes (todos los canales)
messages
â”œâ”€â”€ id
â”œâ”€â”€ thread_id                -- FK a communication_threads
â”œâ”€â”€ sender_id                -- FK a users (nullable)
â”œâ”€â”€ sender_type              -- 'client' | 'agent' | 'system'
â”œâ”€â”€ sender_name
â”œâ”€â”€ sender_email
â”œâ”€â”€ body
â”œâ”€â”€ body_html
â”œâ”€â”€ message_type             -- 'email' | 'whatsapp' | 'sms'
â”œâ”€â”€ metadata                 -- JSON con datos especÃ­ficos
â””â”€â”€ created_at

-- Entregas (tracking)
message_deliveries
â”œâ”€â”€ id
â”œâ”€â”€ message_id               -- FK a messages
â”œâ”€â”€ delivery_method          -- 'email' | 'whatsapp' | 'sms'
â”œâ”€â”€ recipient
â”œâ”€â”€ status                   -- 'sent' | 'delivered' | 'read' | 'failed'
â”œâ”€â”€ provider                 -- 'nodemailer' | 'twilio'
â”œâ”€â”€ provider_message_id      -- SID de Twilio o Message-ID de email
â”œâ”€â”€ error_message
â”œâ”€â”€ sent_at
â”œâ”€â”€ delivered_at
â””â”€â”€ read_at
```

### **Tablas de Soporte**

```sql
-- Tokens de recuperaciÃ³n de contraseÃ±a
password_reset_tokens
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ token
â”œâ”€â”€ expires_at
â”œâ”€â”€ used
â””â”€â”€ created_at

-- Tokens de verificaciÃ³n de email
email_verification_tokens
â”œâ”€â”€ id
â”œâ”€â”€ user_id
â”œâ”€â”€ token
â”œâ”€â”€ expires_at
â”œâ”€â”€ used
â””â”€â”€ created_at

-- Usuarios (modificado)
users
â”œâ”€â”€ id
â”œâ”€â”€ email
â”œâ”€â”€ phone                    -- Para SMS
â”œâ”€â”€ whatsapp_number          -- Para WhatsApp
â”œâ”€â”€ email_verified           -- âœ… Nuevo
â”œâ”€â”€ email_verified_at        -- âœ… Nuevo
â””â”€â”€ ...

-- Reservas (modificado)
bookings
â”œâ”€â”€ id
â”œâ”€â”€ pre_trip_reminder_sent   -- âœ… Nuevo
â”œâ”€â”€ survey_sent              -- âœ… Nuevo
â”œâ”€â”€ survey_token             -- âœ… Nuevo
â””â”€â”€ ...

-- Cotizaciones (modificado)
group_quotes
â”œâ”€â”€ id
â”œâ”€â”€ reminder_sent            -- âœ… Nuevo
â”œâ”€â”€ reminder_sent_at         -- âœ… Nuevo
â””â”€â”€ ...
```

---

## ğŸ¯ **CASOS DE USO COMPLETOS**

### **Caso 1: Nuevo Usuario se Registra**

```
1. Usuario se registra
   â†“
2. Sistema crea usuario (email_verified = false)
   â†“
3. Genera token de verificaciÃ³n
   â†“
4. EnvÃ­a EMAIL de verificaciÃ³n
   â†“
5. Usuario hace click en link
   â†“
6. Email verificado (email_verified = true)
   â†“
7. EnvÃ­a EMAIL de bienvenida
   â†“
8. Usuario puede usar la plataforma
```

### **Caso 2: Usuario Hace Reserva**

```
1. Usuario solicita cotizaciÃ³n
   â†“
2. Agente crea cotizaciÃ³n
   â†“
3. EnvÃ­a EMAIL de cotizaciÃ³n
   â†“
4. [24-48h antes de expirar]
   Cron job envÃ­a EMAIL de recordatorio
   â†“
5. Usuario confirma reserva
   â†“
6. EnvÃ­a EMAIL de confirmaciÃ³n
   â†“
7. Usuario paga
   â†“
8. EnvÃ­a EMAIL de confirmaciÃ³n de pago
   â†“
9. [7, 3, 1 dÃ­a antes del viaje]
   Cron job envÃ­a EMAIL de recordatorio pre-viaje
   â†“
10. Usuario viaja
   â†“
11. [2-3 dÃ­as despuÃ©s]
   Cron job envÃ­a EMAIL de encuesta
```

### **Caso 3: Cliente Contacta por WhatsApp**

```
1. Cliente envÃ­a WhatsApp al nÃºmero de Twilio
   â†“
2. Twilio recibe mensaje
   â†“
3. Twilio llama webhook /api/webhooks/whatsapp
   â†“
4. Sistema busca usuario por nÃºmero
   â†“
5. Busca o crea hilo de conversaciÃ³n
   â†“
6. Guarda mensaje en BD
   â†“
7. Incrementa contador de no leÃ­dos
   â†“
8. Notifica a agentes (opcional)
   â†“
9. Agente ve mensaje en Centro de ComunicaciÃ³n
   â†“
10. Agente responde
   â†“
11. Sistema envÃ­a WhatsApp al cliente
   â†“
12. Twilio notifica estado (entregado/leÃ­do)
   â†“
13. Sistema actualiza estado en BD
```

### **Caso 4: Cambio en Reserva**

```
1. Agente modifica reserva (vuelo, hotel, fecha)
   â†“
2. Agente llama /api/bookings/notify-change
   â†“
3. Sistema envÃ­a EMAIL de cambio de itinerario
   â†“
4. Cliente recibe notificaciÃ³n
   â†“
5. [Opcional] Cliente responde por WhatsApp
   â†“
6. ConversaciÃ³n continÃºa en Centro de ComunicaciÃ³n
```

---

## ğŸ“Š **ESTADÃSTICAS DEL SISTEMA**

### **ImplementaciÃ³n Completa**

- âœ… **14 templates** de email
- âœ… **14 funciones** helper de email
- âœ… **3 canales** de comunicaciÃ³n (Email, WhatsApp, SMS)
- âœ… **10 integraciones** de email
- âœ… **3 cron jobs** automÃ¡ticos
- âœ… **7 endpoints** API
- âœ… **3 webhooks** de Twilio
- âœ… **5 tablas** de BD creadas/modificadas
- âœ… **43 archivos** creados
- âœ… **~8,000 lÃ­neas** de cÃ³digo
- âœ… **100% documentado**

### **Capacidades**

- âœ… EnvÃ­o de emails transaccionales
- âœ… EnvÃ­o de WhatsApp
- âœ… EnvÃ­o de SMS
- âœ… RecepciÃ³n de WhatsApp
- âœ… RecepciÃ³n de SMS
- âœ… Conversaciones bidireccionales
- âœ… Tracking de estado de mensajes
- âœ… Centro de comunicaciÃ³n unificado
- âœ… Cron jobs automÃ¡ticos
- âœ… AutenticaciÃ³n completa
- âœ… Notificaciones de cambios

---

## ğŸ‰ **CONCLUSIÃ“N**

Has implementado un **SISTEMA DE COMUNICACIÃ“N OMNICANAL COMPLETO** que incluye:

### **Email** âœ…
- 14 templates profesionales
- EnvÃ­o automÃ¡tico en todo el ciclo de vida
- Cron jobs para recordatorios
- RecuperaciÃ³n de contraseÃ±a
- VerificaciÃ³n de email

### **WhatsApp** âœ…
- EnvÃ­o de mensajes
- RecepciÃ³n de mensajes
- Conversaciones bidireccionales
- Tracking de estado
- IntegraciÃ³n con Centro de ComunicaciÃ³n

### **SMS** âœ…
- EnvÃ­o de mensajes
- RecepciÃ³n de mensajes
- Conversaciones bidireccionales
- Tracking de estado
- IntegraciÃ³n con Centro de ComunicaciÃ³n

### **Centro de ComunicaciÃ³n** âœ…
- Vista unificada de todos los canales
- GestiÃ³n de conversaciones
- AsignaciÃ³n de agentes
- Historial completo
- MÃ©tricas y estadÃ­sticas

**Â¡Tu plataforma ahora tiene comunicaciÃ³n de nivel empresarial!** ğŸš€

---

**Implementado por:** Antigravity AI  
**Fecha:** 5 de Febrero de 2026  
**VersiÃ³n:** v3.0 Omnichannel Complete
